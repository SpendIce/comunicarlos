meta {
  name: Agregar Comentario (Tecnico)
  type: http
  seq: 4
}

post {
  url: {{base_url}}/api/v1/requerimientos/{{id_incidente}}/comentarios
  body: json
  auth: inherit
}

headers {
  Authorization: Bearer {{token_tecnico}}
  Content-Type: application/json
}

body:json {
  {
    "texto": "Revisando la conexión del nodo principal. Parece haber ruido en la línea."
  }
}

assert {
  res.status: eq 201
}

tests {
  test("El comentario debe tener ID y Fecha", function() {
    const body = res.getBody();
    expect(body.id).to.be.a('number');
    expect(body.fechaHora).to.be.a('string');
  });
  
  test("El texto debe coincidir con el enviado", function() {
    const body = res.getBody();
    const reqBody = req.getBody(); 
    expect(body.texto).to.equal(reqBody.texto);
  });
  
  test("El autor debe ser el técnico actual", function() {
    const body = res.getBody();
    const emailTecnico = bru.getEnvVar("email_tecnico");
    
    expect(body.autor.email).to.equal(emailTecnico);
    expect(body.autor.tipoUsuario).to.equal("TECNICO");
  });
}

settings {
  encodeUrl: true
}
